using System;
using System.Text;

namespace ChargeBee.Api
{
    public sealed class ApiConfig
    {
		public static string DomainSuffix = "chargebee.com";
		public static string Proto = "https";
		public static string Version = "2.9.0";
		public static readonly string API_VERSION = "v2";
        public static int TimeTravelMillis { get; set; }
        public static int ExportSleepMillis { get; set;}

        public string ApiKey { get; set; }
        public string SiteName { get; set; }
        public string Charset { get; set; }

        public string ApiBaseUrl
        {
            get
            {
				return String.Format("{0}://{1}.{2}/api/{3}",
                    Proto,
                    SiteName,
                    DomainSuffix,
					API_VERSION);
            }
        }

        public string AuthValue
        {
            get
            {
                return String.Format("Basic {0}",
                    Convert.ToBase64String(Encoding.UTF8.GetBytes(
                    String.Format("{0}:", ApiKey))));
            }
        }

        private ApiConfig(string siteName, string apiKey)
        {
            Charset = Encoding.UTF8.WebName;
            TimeTravelMillis = 3000;
            ExportSleepMillis = 10000;
            SiteName = siteName;
            ApiKey = apiKey;
        }

        private static volatile ApiConfig m_instance;

        public static void Configure(string siteName, string apiKey)
        {
            m_instance = Create(siteName, apiKey);
        }

        public static ApiConfig Create(string siteName, string apiKey)
        {
            if (m_instance != null)
                throw new Exception("Already configured statically!");

            if (String.IsNullOrEmpty(siteName))
                throw new ArgumentException("Site name can't be empty!");

            if (String.IsNullOrEmpty(apiKey))
                throw new ArgumentException("Api key can't be empty!");

            return new ApiConfig(siteName, apiKey);
        }

        public static ApiConfig Instance
        {
            get
            {
                if (m_instance == null)
                    throw new Exception("Not yet configured!");

                return m_instance;
            }
        }
    }
}
