name: Publish v3 .NET SDK to NuGet
on:
    push:
        tags:
            - 'v3*'
jobs:
    release:
        if: startsWith(github.ref, 'refs/tags/v3')
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4
            
            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: '8.0.x'
            
            - name: Cache NuGet packages
              uses: actions/cache@v4
              with:
                  path: ~/.nuget/packages
                  key: ${{ runner.os }}-nuget-${{ hashFiles('**/ChargeBee.csproj', '**/Chargebee.Tests.csproj') }}
                  restore-keys: ${{ runner.os }}-nuget-
            
            - name: Ensure project version matches tag
              run: |
                  # Extract version from ChargeBee.csproj file
                  VERSION=$(grep -oP '<Version>\K[^<]+' ChargeBee/ChargeBee.csproj | head -1)
                  
                  # If no <Version> tag, try <PackageVersion>
                  if [ -z "$VERSION" ]; then
                    VERSION=$(grep -oP '<PackageVersion>\K[^<]+' ChargeBee/ChargeBee.csproj | head -1)
                  fi
                  
                  # If still no version, try <AssemblyVersion>
                  if [ -z "$VERSION" ]; then
                    VERSION=$(grep -oP '<AssemblyVersion>\K[^<]+' ChargeBee/ChargeBee.csproj | head -1)
                  fi
                  
                  # Last resort: use MSBuild to get version from the specific project
                  if [ -z "$VERSION" ]; then
                    VERSION=$(dotnet msbuild ChargeBee/ChargeBee.csproj -getProperty:Version -nologo | tr -d '\r')
                  fi
                  
                  TAG=${GITHUB_REF#refs/tags/}
                  echo "Detected project version: $VERSION"
                  echo "Detected git tag: $TAG"
                  
                  if [ -z "$VERSION" ]; then
                    echo "❌ ERROR: Could not extract version from ChargeBee/ChargeBee.csproj"
                    exit 1
                  fi
                  
                  if [ "$VERSION" = "${TAG#v}" ]; then
                    echo "✅ OK: Project version matches the tag"
                  else
                    echo "❌ ERROR: Project version ($VERSION) does not match tag ($TAG)"
                    exit 1
                  fi
            
            - name: Restore dependencies
              run: |
                  echo "📦 Restoring dependencies..."
                  dotnet restore
            
            - name: Build project
              run: |
                  echo "🔨 Building project..."
                  dotnet build --configuration Release --no-restore
            
            - name: Run tests
              run: |
                  echo "🧪 Running tests..."
                  dotnet test --configuration Release --no-build --verbosity normal
            
            - name: Create NuGet package
              run: |
                  echo "📦 Creating NuGet package..."
                  dotnet pack ChargeBee/ChargeBee.csproj --configuration Release --no-build --output ./nupkg
            
            - name: Publish to NuGet
              run: |
                  echo "🚀 Publishing to NuGet..."
                  dotnet nuget push "./nupkg/*.nupkg" --api-key "${{ secrets.NUGET_API_KEY }}" --source https://api.nuget.org/v3/index.json --skip-duplicate
              env:
                  NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}